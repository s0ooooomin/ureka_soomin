<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Student Test</title>
</head>
<body>
	<h1>Student.html</h1>
	<hr>
	<table>
		<thead>
			<tr><td>Id</td><td>Name</td><td>email</td><td>phone</td></tr>
		</thead>
		<tbody id="tbodyStudent"></tbody>
	</table>
	<hr>
	<form>
		<table>
			<tbody>
				<tr><td>Name</td><td><input type="text" name="name" id="inputName"></td></tr>
				<tr><td>Email</td><td><input type="text" name="email" id="inputEmail"></td></tr>
				<tr><td>Phone</td><td><input type="text" name="phone" id="inputPhone"></td></tr>
			</tbody>
		</table>
	</form>
	<div style="border: 1px; margin: auto; text-align: center">
		<button id="btnInsert">등록</button>
		<button id="btnUpdate">수정</button>
		<button id="btnDelete">삭제</button>
		<button id="btnClear">초기화</button>
	</div>
	
	<script>

		let CURRENT_ID;
		
		window.onload = function(){
			
			listStudent();
			
			// 이벤트 핸들러 등록
			document.querySelector("#btnInsert").onclick = insertStudent;
			document.querySelector("#btnUpdate").onclick = updateStudent;			
			document.querySelector("#btnDelete").onclick = deleteStudent;
			document.querySelector("#btnClear").onclick = clear;
		}
	
		async function listStudent(){
			let url = '/api/re/students';
			
			// 낙관적 대응
// 			try{
// 				let response = await fetch(url);
// 				console.log(response)
// 				let data = await response.json();	
// 				makeListHtml( data.list );
// 				// 위 코드 대신data.list 대신 
// 				// let {list} = await response.json();
// 				// makeListHtml(list) 를 사용할 수도 있다.
// 			}catch(error){
// 				alert("학생 조회 과정 중 오류가 발생했습니다.")
// 				console.log(error)
// 			}
			// 비관적 대응
			// response 응답코드 확인
			try{
				let response = await fetch(url);
				console.log(response)

				if (response.ok) {
					let data = await response.json();	
					makeListHtml( data.list );
				}else {
					switch(response.status) {
						case 404: alert("학생데이터를 찾을 수 없습니다."); break;
						case 500: alert("학생 조회 과정 중 서버 오류 발생"); break;
						
					}
				}
			}catch(error){
				alert("학생 조회 과정 중 오류가 발생했습니다.")
				console.log(error)
			}

		}
		
		function makeListHtml(list){
			let listHtml = ``;
			list.forEach( el => {
				let id = el.id;
				let name = el.name;
				let email = el.email;
				let phone = el.phone;
				
				listHtml += `<tr style="cursor: pointer;" data-id=${id}><td>${id}</td><td>${name}</td><td>${email}</td><td>${phone}</td></tr>`;
			});
			
			document.querySelector("#tbodyStudent").innerHTML = listHtml;
			
			document.querySelectorAll("#tbodyStudent tr").forEach( el => {
				el.onclick = function(){
					let id = this.getAttribute("data-id");
					detailStudent(id);
				}
			});
		}

		async function detailStudent(id){
		
			let url = '/api/re/students/' + id;

// 			try{
// 				let response = await fetch(url);
// 				console.log(response)
// 				let {dto} = await response.json(); // javascript es6 destruction 문법
// 				makeDetailHtml( dto );
// 			}catch(error){
// 				console.log("detail error")
// 				console.log(error)
// 			}
			try{
				let response = await fetch(url);
				console.log(response)
				
				if( response.ok ){
					let data = await response.json();// 백엔드에서 body 가 null 로 리턴 안 할 수도 있다.
					makeDetailHtml( data ); // StudentResultDto 의 일부인 StudentDto 가 바로 응답된다.
				}else{
					// #1. 일반화된 오류 출력
// 					alert("학생 조회 과정 중 오류가 발생했습니다.");
					// #2. 세분화된 오류 출력
					switch(response.status){
						case 404: alert("학생 데이터를 찾을 수 없습니다."); break;
						case 500: alert("학생 조회 과정 중 서버 오류가 발생했습니다."); break;
					}
				}
			}catch(error){
				alert("학생 조회 과정 중 오류가 발생했습니다.")
				console.log(error)
			}	
	
		}
		
		function makeDetailHtml(detail){
			console.log(detail);
			
			CURRENT_ID = detail.id;
			
			document.querySelector("#inputName").value = detail.name;
			document.querySelector("#inputEmail").value = detail.email;
			document.querySelector("#inputPhone").value = detail.phone;
			
		}
		
		async function insertStudent(){
			
			let name = document.querySelector("#inputName").value;
			let email = document.querySelector("#inputEmail").value;
			let phone = document.querySelector("#inputPhone").value;

			let jsonParams = JSON.stringify({	name, email, phone	});

			let fetchOptions = {
				method : "POST",
				headers : {
					"Content-Type" : "application/json"
				},
		        body: jsonParams,
			}
			
			let url = '/api/re/students';
			
// 			try{
// 				let response = await fetch(url, fetchOptions)
// 				let data = await response.json();
// 				console.log(data);
// 				listStudent();
// 				clear();
// 			}catch(error){ // BE 404 에러는 이곳에
// 				console.log(error)
// 			}

			try{
				let response = await fetch(url, fetchOptions);
				console.log(response);
				
				if( response.ok ){
					console.log("200");
					
					listStudent();
					clear();
				
				}else{
					switch(response.status){
						case 404: alert("학생 등록을 할 수 없습니다."); break;
						case 500: alert("학생 등록 과정 중 서버 오류 발생"); break;
					}
				}
			}catch(error){
				alert("학생 등록 과정 중 오류가 발생했습니다.")
				console.log(error)
			}	

		}

		async function updateStudent(){

			let url = '/api/re/students/' + CURRENT_ID;

			let id = CURRENT_ID;
			let name = document.querySelector("#inputName").value;
			let email = document.querySelector("#inputEmail").value;
			let phone = document.querySelector("#inputPhone").value;
			
			
			let jsonParams = JSON.stringify({	id, name, email, phone	});

			let fetchOptions = {
				method : "PUT",
				headers : {
					"Content-Type" : "application/json"
				},
		        body: jsonParams,
			}
			
			try{
				let response = await fetch(url, fetchOptions);
				console.log(response);
				
				if( response.ok ){
					console.log("200");
					
					listStudent();
					clear();
				
				}else{
					switch(response.status){
						case 404: alert("학생 수정을 할 수 없습니다."); break;
						case 500: alert("학생 수정 과정 중 서버 오류 발생"); break;
					}
				}
			}catch(error){
				alert("학생 수정 과정 중 오류가 발생했습니다.")
				console.log(error)
			}	
		}
		
		async function deleteStudent(){
			let url = '/api/students/' + CURRENT_ID;

			let fetchOptions = {
				method : "DELETE",
			}
			
			try{
				let response = await fetch(url, fetchOptions);
				console.log(response);
				
				if( response.ok ){
					let data = await response.json();
					console.log("200");
					
					listStudent();
					clear();
				
				}else{
					switch(response.status){
						case 404: alert("학생 삭제를 할 수 없습니다."); break;
						case 500: alert("학생 삭제 과정 중 서버 오류 발생"); break;
					}
				}
			}catch(error){
				alert("학생 삭제 과정 중 오류가 발생했습니다.")
				console.log(error)
			}	
		}
		
		function clear(){
			document.querySelector("#inputName").value = "";
			document.querySelector("#inputEmail").value = "";
			document.querySelector("#inputPhone").value = "";
		}
		
	</script>	
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<h1>login.html</h1>
	<hr>

	<input type="text" id="username" name="username" value="dskim"><br>
	<input type="text" id="password" name="password" value="1234"><br>
	
	<!-- csrf token -->
	<input type="hidden" id="_csrf" name="_csrf" value=""><br>
	
	<button id="btnLogin">Login</button>
	
	<!-- 
		로그인 실패 표시 영역 
		최초 empty 이므로 보이지 않는다. 에러 메시지가 채워지면 빨간색으로 보인다.
	-->
	<div id="errorMessage" style="color: red; margin-top: 10px;"></div>
<script>
	window.onload = function(){
		getCsrfToken();
		
		document.querySelector("#btnLogin").onclick = login;
	}
	
	// csrf controller 에 token 요청
	async function getCsrfToken(){
		let response = await fetch("/csrf-token", {method: "get", credentials: "same-origin"});
		console.log(response);
		let data = await response.json();
		console.log(data);
		document.querySelector("#_csrf").value = data.token;
	}
	
	// 로그인 
	async function login(){
		
		let url = "/login";
		
		let username = document.querySelector("#username").value;
		let password = document.querySelector("#password").value;
		let _csrf = document.querySelector("#_csrf").value;
		
		let urlParams = new URLSearchParams({
			username, password, _csrf  // javascript es6 shorthand property 문법
		});
		
		let fetchOptions = {
			method: "post",
			body: urlParams
		}
		
		let response = await fetch(url, fetchOptions);
		let data = await response.json();
		
		console.log(data);
		
		if (data.result == "success") {
			window.location.href="/";
		}else {
			document.querySelector("#errorMessage").innerText = "올바르지않잖아요";
		}
		
		
	}
	
</script>	
</body>
</html>
<!-- csrf 설정 후 받은 token을 전송해야함 
	login2.html로 변경 후 새로운 login.html 생성
 -->